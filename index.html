<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Visualizing Time Series</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<style>
			body {
				-webkit-touch-callout: none;
				-webkit-user-select: none;
				-khtml-user-select: none;
				-moz-user-select: none;
				-ms-user-select: none;
				user-select: none;
				cursor: default;
			}

			td { border-bottom: solid 2px white; font-family: "Monaco", "Lucida Console", monospace;}
			td.centerCell {border-left: solid 2px white; border-bottom: solid 2px white; font-family: "Monaco", "Lucida Console", monospace;}
			
			/* anscomb's quatret */
			div.anscomb {display: inline-block; margin-left: 40px; width: 130px;}

			/* colors */
			.blue { color: rgb(66, 175, 250); }
			.red  { color: rgb(255, 153, 153);}
			
			text {
				cursor: default;
				-webkit-touch-callout: none;
				-webkit-user-select: none;
				-khtml-user-select: none;
				-moz-user-select: none;
				-ms-user-select: none;
				user-select: none;
			}
			
			.axis text { fill: white; font-family: 'Source Sans Pro', Helvetica; font-size: 14pt;}
			.axis line,
			.axis path {
				fill: none;
				stroke: white;
				shape-rendering: crispEdges;
			}

			.reveal table {
			  margin: auto;
			  border-collapse: collapse;
			  border-spacing: 0;
			}

			.reveal table th {
			  font-weight: bold;
			}

			.reveal table th,
			.reveal table td {
			  text-align: left;
			  padding: 0.2em 0.5em 0.2em 0.5em;
			  border-bottom: 1px solid;
			}


		</style>

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>

		<script src="lib/data/d3.min.js"></script>
		<script src="lib/data/jquery.min.js"></script>

		<script src="lib/data/papaparse.min.js"></script>
		<script src="lib/vis/timeseries.js"></script>
		<script src="lib/vis/oecd.js"></script>
		<script src="lib/vis/lineplot.js"></script>
		<script src="lib/vis/ui_utils.js"></script>
		<script src="lib/vis/cabon.js"></script>
		<script src="lib/vis/dow.js"></script>
		<script src="lib/vis/stripes.js"></script>
		<script src="lib/vis/horizon.js"></script>
		<script src="lib/vis/weather.js"></script>
		<script src="lib/vis/helper.js"></script>

		<div class="reveal">
			<div class="slides">
				
				<!-- intro slide -->
				<section data-background-image="img/pianoStrings.png">
					<div style="background-color: rgba(0,0,0,0.4); width: 600px; text-align: left">
						<h1>Visualizing<br>Time Series</h1>
						<!--
						<p>&nbsp;
						<p>
							Khairi Reda<br>
							Leadership Computing Facility
						-->
					</div>
				</section>

				<section>
					<h2>Khairi Reda</h2>
					<!--<a href="http://vis.ninja/">http://vis.ninja</a><br>-->
					<a href="mailto:redak@iu.edu">redak@iu.edu</a><br>
					<a href="http://twitter.com/RedKhair">@RedKhair</a>
				</section>

				<!-- why need vis: anscombe's quatret -->
				<section id="fragments">
					<div style="font-size: 15pt" class="fragment">
						<div class="anscomb">
								&nbsp;
						</div>
						<div class="anscomb">
							<h3>set A</h3>
							<table cellspacing="0">
								<tr>
									<td style="text-align: center">x</td>
									<td style="text-align: center">y</td>
								</tr>
									<tr><td>	10</td> <td class="centerCell">	8.04</td></tr>
									<tr><td>	8</td>	<td class="centerCell">	6.95</td></tr>
									<tr><td>	13</td>	<td class="centerCell">	7.58</td></tr>
									<tr><td>	9</td>	<td class="centerCell">	8.81</td></tr>
									<tr><td>	11</td>	<td class="centerCell">	8.33</td></tr>
									<tr><td>	14</td>	<td class="centerCell">	9.96</td></tr>
									<tr><td>	6</td>	<td class="centerCell">	7.24</td></tr>
									<tr><td>	4</td>	<td class="centerCell">	4.26</td></tr>
									<tr><td>	12</td>	<td class="centerCell">	10.84</td></tr>
									<tr><td>	7</td>	<td class="centerCell">	4.82</td></tr>
									<tr><td>	5</td>	<td class="centerCell">	5.68</td></tr>
							</table>
						</div>

						<div class="anscomb">
							<h3>set B</h3>
							<table cellspacing="0">
								<tr>
									<td style="text-align: center">x</td>
									<td style="text-align: center">y</td>
								</tr>
								<tr><td>10	</td><td class="centerCell">	9.14</td></tr>
								<tr><td>8		</td><td class="centerCell">8.14</td></tr>
								<tr><td>13	</td><td class="centerCell">	8.74</td></tr>
								<tr><td>9		</td><td class="centerCell">8.77</td></tr>
								<tr><td>11	</td><td class="centerCell">	9.26</td></tr>
								<tr><td>14	</td><td class="centerCell">	8.1</td></tr>
								<tr><td>6		</td><td class="centerCell">6.13</td></tr><tr>
								<td>4	</td><td class="centerCell">	3.1</td></tr>
								<tr><td>12	</td><td class="centerCell">	9.13</td></tr>
								<tr><td>7		</td><td class="centerCell">7.26</td></tr>
								<tr><td>5		</td><td class="centerCell">4.74</td></tr>
							</table>
						</div>

						<div class="anscomb">
							<h3>set C</h3>
							<table cellspacing="0">
								<tr>
									<td style="text-align: center">x</td>
									<td style="text-align: center">y</td>
								</tr>
								<tr><td>10	</td><td class="centerCell">		7.46</td></tr>
								<tr><td>8		</td><td class="centerCell">	6.77</td></tr>
								<tr><td>13	</td><td class="centerCell">		12.74</td></tr>
								<tr><td>9		</td><td class="centerCell">	7.11</td></tr>
								<tr><td>11	</td><td class="centerCell">		7.81</td></tr>
								<tr><td>14	</td><td class="centerCell">		8.84</td></tr>
								<tr><td>6		</td><td class="centerCell">	6.08</td></tr>
								<tr><td>4		</td><td class="centerCell">	5.39</td></tr>
								<tr><td>12	</td><td class="centerCell">		8.15</td></tr>
								<tr><td>7		</td><td class="centerCell">	6.42</td></tr>
								<tr><td>5		</td><td class="centerCell">	5.73</td></tr>
							</table>
						</div>
						
						<div class="anscomb">
							<h3>set D</h3>
							<table cellspacing="0">
								<tr>
									<td style="text-align: center">x</td>
									<td style="text-align: center">y</td>
								</tr>

								<tr><td>8		</td><td class="centerCell">	6.58</td></tr>
								<tr><td>8		</td><td class="centerCell">	5.76</td></tr>
								<tr><td>8		</td><td class="centerCell">	7.71</td></tr>
								<tr><td>8		</td><td class="centerCell">	8.84</td></tr>
								<tr><td>8		</td><td class="centerCell">	8.47</td></tr>
								<tr><td>8		</td><td class="centerCell">	7.04</td></tr>
								<tr><td>8		</td><td class="centerCell">	5.25</td></tr>
								<tr><td>19	</td><td class="centerCell">		12.5</td></tr>
								<tr><td>8		</td><td class="centerCell">	5.56</td></tr>
								<tr><td>8		</td><td class="centerCell">	7.91</td></tr>
								<tr><td>8		</td><td class="centerCell">	6.89</td></tr>
							</table>
						</div>
					</div>

					<div class="fragment">
						<div class="anscomb" style="text-align: left">
							mean
						</div>

						<div class="anscomb">
							<div class="blue" style="font-size: 20pt">9.00 | 7.50</div>
						</div>

						<div class="anscomb">
							<span class="blue" style="font-size: 20pt">9.00 | 7.50</span>
						</div>
						
						<div class="anscomb">
							<span class="blue" style="font-size: 20pt">9.00 | 7.50</span>
						</div>
						
						<div class="anscomb">
							<span class="blue" style="font-size: 20pt">9.00 | 7.50</span>
						</div>
						
					</div>

					<div class="fragment">
						<div class="anscomb" style="text-align: left">
							variance
						</div>

						<div class="anscomb">
							<div class="blue" style="font-size: 20pt">11.00 | 4.12</div>
						</div>

						<div class="anscomb">
							<span class="blue" style="font-size: 20pt">11.00 | 4.12</span>
						</div>
						
						<div class="anscomb">
							<span class="blue" style="font-size: 20pt">11.00 | 4.12</span>
						</div>
						
						<div class="anscomb">
							<span class="blue" style="font-size: 20pt">11.00 | 4.12</span>
						</div>
						
					</div>

					<div class="fragment">
						<div class="anscomb" style="text-align: left">
							correlation
						</div>

						<div class="anscomb">
							<div class="blue" style="font-size: 20pt">0.816</div>
						</div>

						<div class="anscomb">
							<span class="blue" style="font-size: 20pt">0.816</span>
						</div>
						
						<div class="anscomb">
							<span class="blue" style="font-size: 20pt">0.816</span>
						</div>
						
						<div class="anscomb">
							<span class="blue" style="font-size: 20pt">0.816</span>
						</div>
						
					</div>

					<div class="fragment">
						<div class="anscomb" style="text-align: left">
							regression
						</div>

						<div class="anscomb">
							<div class="red" style="font-size: 20pt">Y = .5X + 3</div>
						</div>

						<div class="anscomb">
							<span class="red" style="font-size: 20pt">Y = .5X + 3</span>
						</div>
						
						<div class="anscomb">
							<span class="red" style="font-size: 20pt">Y = .5X + 3</span>
						</div>
						
						<div class="anscomb">
							<span class="red" style="font-size: 20pt">Y = .5X + 3</span>
						</div>
					</div>

					<div class="fragment">
						<div class="anscomb" style="text-align: left">
							R<sup><font size="-1">2</font></sup>
						</div>

						<div class="anscomb">
							<div class="red" style="font-size: 20pt">0.66</div>
						</div>

						<div class="anscomb">
							<span class="red" style="font-size: 20pt">0.66</span>
						</div>
						
						<div class="anscomb">
							<span class="red" style="font-size: 20pt">0.66</span>
						</div>
						
						<div class="anscomb">
							<span class="red" style="font-size: 20pt">0.66</span>
						</div>
					</div>
				</section>

				<!-- picture of anscomb's quatret -->
				<section data-background-color="white">
					<img data-src="img/anscomb.png" style="background:none; border:none; box-shadow:none;">
				</section>

				<!-- visualizing times series -->
				<section>
					<div>
						<h4 style="text-align: left">Visual representations<br>for time series</h4>
						<ul>
							<li class="fragment">Line charts</li>
							<li class="fragment">Stripe glyphs</li>
							<li class="fragment">Star glyphs and radial layouts</li>
							<li class="fragment">Interactive techniques</li>
							<li class="fragment">Scatterplots</li>
						</ul>

					</div>
				</section>
 
				<!-- line charts -->
				<section>
					<h2>Line charts</h2>
				</section>

				<section data-background-color="white">
					<img data-src="img/Playfair_Timeseries.png" style="background:none; border:none; box-shadow:none;">
				</section>

				<section>
					<div style="">
						<svg id="linechartOECD" width="1100" height="500"></svg><br>
						Gross Domestic Product (USD per capita)
					</div>

				</section>

				<section>
					<svg id="oecdSmallMultiples" width="1800" height="1000"></svg>
				</section>

				<section>
					<div style="text-align: left">
						<h3>Aspect ratio matters</h3>
						The average absolute orientation of line segments should be close to 45&#176;
					</div>
					<div class="fragment" style="text-align: left">
							Atmospheric Carbon Dioxide
							<svg id="linechartCarbon" width="1350" height="700"></svg><br>
					</div>
					<div class="fragment">

					</div>

				</section>

				<!-- stripes -->
				<section>
					<h2>Stripe chart</h2>
					Encode time series value with color as opposed to position

					<div style="text-align: center">
						<div text>
							<p>&nbsp;<p>&nbsp;
							<div style="text-align: center">
								Dow Jones index<br>
								<svg id="linechartDow" width="1000" height="200"></svg><br>
							</div>
						</div>
						<div>
							<canvas class="fragment" id="canvasDow1" width="1000" height="70" style="border: solid 1px white; background-color: white"></canvas><br>
							<canvas class="fragment" id="canvasDow2" width="1000" height="70" style="border: solid 1px white; background-color: white"></canvas><br>
							<canvas class="fragment" id="canvasDow3" width="1000" height="70" style="border: solid 1px white; background-color: white"></canvas><br>
							<canvas class="fragment" id="canvasDow4" width="1000" height="70" style="border: solid 1px white; background-color: white"></canvas><br>
							<canvas class="fragment" id="canvasDow5" width="1000" height="70" style="border: solid 1px white; background-color: white"></canvas><br>
							<canvas class="fragment" id="canvasDow6" width="1000" height="70" style="border: solid 1px white; background-color: white"></canvas><br>

						</div>
					</div>
				</section>

				<section>
					<h2>Stripe chart</h2>
					High frequency noise

					<div style="text-align: center">
						<div classs="fragment">
							<p>&nbsp;<p>&nbsp;
							<svg id="linechartCosine" width="1200" height="130"></svg><br>
						</div>
						<div>
							<canvas class="fragment" id="canvasCosine" width="1200" height="100" style="border: solid 1px white; background-color: white"></canvas><br>
						</div>
					</div>

					<script type='text/javascript'>
						
							var showNoise = true;
							var preNoiseSeries = new Timeseries(3000).zero().cosineWave(10, 500, 0).cosineWave(26, 2000, 200).cosineWave(5, 900, 100).cosineWave(15, 200, 50);
							var noisedSeries = preNoiseSeries.clone().noise([-50, 50])
							var cosinePlot = visLinePlot('linechartCosine', noisedSeries, { yAxis: false, xAxis: false, stroke_width: 2, padW: 0 });
							
							var canvas2 = d3.select('#canvasCosine');
							new StripesPlot(canvas2, +canvas2.attr('width'), +canvas2.attr('height'), noisedSeries.clone().smooth(7));
						
							d3.select("#linechartCosine").on('dblclick', function() 
							{					
								showNoise = !showNoise;
								var timeseries = showNoise ? noisedSeries : preNoiseSeries;
								cosinePlot.updateTimeseries(0, timeseries);
								new StripesPlot(canvas2, +canvas2.attr('width'), +canvas2.attr('height'), showNoise ? timeseries.clone().smooth(7) : timeseries);
							});
					</script>
				</section>


				<section>
					<h2>Horizon chart</h2>
					<svg id="horizonChart1" width="1600" height="200" style=""><defs></defs></svg><br>
					<svg class="fragment" id="horizonChart2" width="1600" height="300" style=""><defs></defs></svg>
				</section>

				<section>
					<h2>Temperature anomalies</h2>
					<svg id="temperatureSVG" width="1500" height="750">
						<defs></defs>
					</svg>
					<div>
						Data: <a href="http://berkeleyearth.lbl.gov/city-list/">http://berkeleyearth.lbl.gov/city-list/</a>
					</div>
					<script type="text/javascript">
						var WEATHER_CITIES = [
							{ name: 'Chicago'		, url: 'data/temperature/chicago.txt' 	},
							{ name: 'NYC'			, url: 'data/temperature/new_york.txt'	},
							{ name: 'New Delhi'		, url: 'data/temperature/new_delhi.txt'	},
							{ name: 'Tokyo'			, url: 'data/temperature/tokyo.txt'		},
							{ name: 'Sao Paulo'		, url: 'data/temperature/sao_paulo.txt'	},
							{ name: 'Moscow'		, url: 'data/temperature/moscow.txt'	},
							{ name: 'Baghdad'		, url: 'data/temperature/baghdad.txt'	},
							{ name: 'Sydney'		, url: 'data/temperature/sydney.txt'	},
							{ name: 'Los Angeles'	, url: 'data/temperature/los_angeles.txt'},
							{ name: 'Montreal'		, url: 'data/temperature/montreal.txt'},
							{ name: 'Brasilia'		, url: 'data/temperature/brasilia.txt'},
							{ name: 'Rome'			, url: 'data/temperature/rome.txt'},
							{ name: 'Aleppo'		, url: 'data/temperature/aleppo.txt'},
							{ name: 'Philadelphia'	, url: 'data/temperature/philly.txt'},
							{ name: 'Johannesburg'	, url: 'data/temperature/johannesburg.txt'},
							{ name: 'Mexico City'	, url: 'data/temperature/mexico_city.txt'},
							{ name: 'Dubai'			, url: 'data/temperature/dubai.txt'},
							{ name: 'Bangkok'		, url: 'data/temperature/bangkok.txt'},
							{ name: 'Reykjavik'		, url: 'data/temperature/Reykjavik.txt'},
							{ name: 'Athens'		, url: 'data/temperature/athens.txt'}

						];

						var weather = new WeatherData(WEATHER_CITIES, function(weather, timeseries) 
						{
							for (var i=0, N=WEATHER_CITIES.length; i<N; i++) {
								WEATHER_CITIES[i].timeseries = timeseries[i].smooth(20, true);
								WEATHER_CITIES[i].index = i;
							}
							var globalExtents = weather.getExtents();

							var HORIZON_W = 1250;
							var HORIZON_H = 28;
							var HORIZON_OFFSET_X = 180;
							var HORIZON_OFFSET_Y = 80;
							var HORIZON_FONT_SIZE = 22;

							var svg = d3.select('#temperatureSVG')
								.on('dblclick', function(d, index) 
								{
									d3.select(this).selectAll('g.weatherGroup').each(function(d, index) {
										(function(index, group) 
										{
											var delay = 250+50*index;
											console.log("setting timeout: " + delay + ", for: " + index);
											setTimeout(function() {
												group.transition().duration(500).style("fill-opacity", '1.0').style('fill-opacity', '1.0');
											}, 0 + 130*index);
										})(index, d3.select(this));
									});
								});

							var cityGroup = svg.selectAll('g').data(WEATHER_CITIES).enter().append('g')
								.attr('class', 'weatherGroup')
								.attr('transform', function(d, i) { return 'translate(' + HORIZON_OFFSET_X + ',' + (HORIZON_OFFSET_Y+i*(HORIZON_H+2)) + ')';})
								.each(function(d, index) {
									if (d.index > 0) {
										d3.select(this)
											.style('fill-opacity', 0.0).style('stroke-opacity', 0.0);
									}
								})


							cityGroup.selectAll('text').data(function(d) { return [d]; }).enter().append('text')
								.html(function(d) { return d.name; })
								.style('fill', 'white').style('font-family', 'Source Sans Pro').style('font-size', HORIZON_FONT_SIZE + 'px')
								.attr('x', -10).attr('y', HORIZON_H/2 + HORIZON_FONT_SIZE/2)
								.attr('text-anchor', 'end');

							cityGroup.selectAll('g').data(function(d) { return [d]; }).enter().append('g')
								.attr('class', 'temperatureHorizonPlot')
								.each(function(d) {
									var plot = (new HorizonPlot(d3.select(this), HORIZON_W, HORIZON_H, d.timeseries, 4, 0));
									if (d.index == 0) {
										plot.colorBands();
									} else {
										plot.deploy();
									}
									if (d.index == WEATHER_CITIES.length-1) {
										plot.drawTimeAxis( weather.getStartTime(), weather.getEndTime() );
									}
								});

						}, new Date('1850-1-1'), new Date('2013-12-1'));

					</script>
				</section>
			</div>
		</div>
		
		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>


		<script>
			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				history: true,
			    width: 1600,
			    height: 1200,
				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>

		<script type="text/javascript">

			// load OCED data
			var svg = d3.select("#linechartOECD");
			var w = +svg.attr("width")-40;
			var h = +svg.attr('height');
			var plot = new LinePlot(svg, w, h);
			var OECD_PLOTS = [
				{ country: "USA", color: '#80d4ff', label: 'US' },
				{ country: "GBR", color: '#ff9999', label: 'UK' },
				{ country: "DEU", color: '#ffcc66', label: 'Germany'},
				{ country: 'FRA', color: '#ffb3ff', label: 'France' },
				{ country: 'AUS', color: '#ff8000', label: 'Australia' },
				{ country: 'CAN', color: '#ff3333', label: 'Canada'},
				{ country: 'GRC', color: '#99ffcc', label: 'Greece'},
				{ country: 'HUN', color: '#ffffcc', label: 'Hungary'},
				{ country: 'IRL', color: '#99ff99', label: 'Ireland'},
				{ country: 'JPN', color: '#ffffff', label: 'Japan'},
				{ country: 'LUX', color: '#3399ff', label: 'Luxembourg'},
				{ country: 'MEX', color:  '#4dffb8', label: 'Mexico' },
				{ country: 'NLD', color: '#d580ff', label: 'Netherland'},
				{ country: 'TUR', color: '#ff3333', label: 'Turkey'},
				{ country: 'NOR', color: '#ffff00', label: 'Norway'},
				{ country: 'SAU', color: '#00ff00', label: 'Saudi Arabia'}

			];
			var OECD_INDEX = 1;
			var oecd = new OECDData('data/DP_LIVE_28062016231151406.csv', function(oecd) 
			{
				// add the US
				var USA = oecd.getLocationTimeseries('USA', 'GDP');
				plot.addTimeseries(USA, "US", '#80d4ff');

				// update date range
				plot.setDateRange([oecd.getStartYear() + '-1-1', oecd.getEndYear() + '-1-1']);

				// small multiples
				makeOECDSmallMultiples();

				d3.select('body').on("keydown", function() {
					
					var keyCode = d3.event.keyCode;

					switch (Reveal.getIndices().h)
					{ 
					case 7:
					
						if (keyCode == 65) {
							if (OECD_INDEX < OECD_PLOTS.length) 
							{
								var i = OECD_INDEX;
								var ts = oecd.getLocationTimeseries(OECD_PLOTS[i].country, 'GDP');
								plot.addTimeseries(ts, OECD_PLOTS[i].label, OECD_PLOTS[i].color);
								OECD_INDEX++;
							}
						} else if (keyCode == 68) {
							plot.popTimeseries();
							if (OECD_INDEX > 0) {
								OECD_INDEX--;
							}
						}
						break;

					case 8:
						if (keyCode == 89)
						{
							flipOECDYRange();
						}
						break;

					case 9:
						switch(d3.event.keyCode)
						{
						case 65:
							// A
							if (carbonPlot.getSeriesCount() < 2) {
								carbonPlot.addTimeseries(carbonTimeseries.clone().smooth(365, true), null, '#ff9999');
							}
							break;
						case 68:
							if (carbonPlot.getSeriesCount() > 1) {
								carbonPlot.popTimeseries();
							}
							break;
						}
					
					case 10:
						// Dow smooth
						switch (d3.event.keyCode)
						{
						case 65:
							changeDowSmooth(1);
							break;
						case 68:
							changeDowSmooth(-1);
							break;
						}
					}
				})
			});

			// small multiples OECD
			var oecdSmallMultiples = [], oecdGlobalScale = true, oecdYRange = null;
			function makeOECDSmallMultiples()
			{
				var svg = d3.select("#oecdSmallMultiples");
				var w = +svg.attr('width');
				var h = +svg.attr('height');
				
				var oecdGroups = svg.selectAll('g').data(OECD_PLOTS).enter().append('g')
					.attr('transform', function(d, i) {
						return 'translate(' + (Math.floor(i/4)*w/4) + ',' + ((i%4) * (h/4)) + ')';
					})
					.each(function(d, i) 
					{
						var g = d3.select(this);
						var plot = new LinePlot(g, w/4-30, h/4-5, {
							resizable: false, 
							xAxis: false, 
							hoverCallback: function(timestep, initiator) 
							{
								for (var i=0, N=oecdSmallMultiples.length; i<N; i++) {
									var plot = oecdSmallMultiples[i];
									if (plot != initiator) {
										plot.showHoverBalls(timestep);
									}
								}
							} 
						});
						oecdSmallMultiples.push(plot);

						var timeseries = oecd.getLocationTimeseries(d.country, 'GDP');
						plot.addTimeseries(timeseries, d.label, d.color);
						plot.setDateRange([oecd.getStartYear() + '-1-1', oecd.getEndYear() + '-1-1']);

					})
				
				oecdYRange = [Number.MAX_VALUE, -Number.MAX_VALUE];
				for (var i=0, N=oecdSmallMultiples.length; i<N; i++) 
				{
					var plot = oecdSmallMultiples[i];
					var yRange = plot.getYRange(plot);

					oecdYRange[0] = Math.min(oecdYRange[0], yRange[0]);
					oecdYRange[1] = Math.max(oecdYRange[1], yRange[1]);
				}
				
				if (oecdGlobalScale)
				{
					for (var i=0, N=oecdSmallMultiples.length; i<N; i++) 
					{
						var plot = oecdSmallMultiples[i];
						plot.setYRange( oecdYRange );
					}
				}
			}

			function flipOECDYRange() 
			{
				oecdGlobalScale = !oecdGlobalScale;
				for (var i=0, N=oecdSmallMultiples.length; i<N; i++) 
				{
					var plot = oecdSmallMultiples[i];
					plot.setYRange( oecdGlobalScale ? oecdYRange : undefined );
				}
			}

			// ====================================
			// Carbon Dioxide 
			var carbonTimeseries = null, carbonPlot;
			var carbon = new CarbonData('data/carbon.txt', function(carbon) 
			{
				carbonTimeseries = carbon.getTimeseries();
				var svg = d3.select("#linechartCarbon");
				var w = 550 - 20;
				var h = +svg.attr('height')-20;

				carbonPlot = new LinePlot(svg, w, h, {stroke_width: 3, interpolate: 'linear'});
				carbonPlot.addTimeseries(carbonTimeseries, null, '#80d4ff');
				carbonPlot.setDateRange([carbon.getStartTime(), carbon.getEndTime()]);
				carbonPlot.setResizeCallback(updateChartInfo);

				// text to show average line segment orientation and aspect ratio
				var carbonChartInfo = svg.append("text")
					.attr('x', 5).attr('y', h+35)
					.style('fill', 'white').style('font-family', 'Source Sans Pro').style('font-size', '20pt');
				//updateChartInfo(w, h);

				function updateChartInfo(width, height) {
					var avgAngle = carbonPlot.avgSegmentOrientation(0);
					var aspectRatio = width / height;
					carbonChartInfo
						.attr('y', height+35)
						.html("Average line segment orientation: " + avgAngle.toFixed(1) + ', Aspect ratio: ' + aspectRatio.toFixed(1));
				}
			});

			// ===========================================
			// Dow Jones industrial
			var dowTimeseries = null, dowTimeseriesSmoothed = null, dowPlot;
			var dowSmooth = 3;

			var dow = new DowData('data/dow.csv', function(dow) 
			{
				dowTimeseries = dow.getTimeseries();
				var svg = d3.select("#linechartDow");
				var w = +svg.attr('width');
				var h = +svg.attr('height');
				dowPlot = new LinePlot(svg, w, h, {
					yAxis: false, xAxis: true, stroke_width: 2, interpolate: 'linear', padW: 0,
					hoverCallback: function() {}, hoverCircleR: 8

				});
				dowPlot.setDateRange([dow.getStartTime(), dow.getEndTime()]);

				changeDowSmooth(0);
				drawHorizonChart(dowTimeseriesSmoothed);
			});

			function changeDowSmooth(delta) {
				dowSmooth += delta*6;
				if (dowSmooth < 1) {
					dowSmooth = 1;
				}
				dowTimeseriesSmoothed = dowTimeseries.clone();
				if (dowSmooth > 1) {
					dowTimeseriesSmoothed.smooth(dowSmooth);
				}
				drawDowCharts();
			}

			function drawDowCharts()
			{
				dowPlot.popTimeseries();
				dowPlot.addTimeseries(dowTimeseriesSmoothed, null, '#80d4ff');

				var STRIPE_CHARTS = [
					{ canvas: 'canvasDow1', colorScale: STRIPE_COLOR_SCALE0},
					{ canvas: 'canvasDow2', colorScale: STRIPE_COLOR_SCALE1},
					{ canvas: 'canvasDow3', colorScale: STRIPE_COLOR_SCALE3},
					{ canvas: 'canvasDow4', colorScale: STRIPE_COLOR_SCALE4},
					{ canvas: 'canvasDow5', colorScale: STRIPE_COLOR_SCALE5},
					{ canvas: 'canvasDow6', colorScale: STRIPE_COLOR_SCALE6},
				];

				for (var i=0; i < STRIPE_CHARTS.length; i++) {
					canvas = d3.select('#' + STRIPE_CHARTS[i].canvas);
					new StripesPlot(canvas, +canvas.attr('width'), +canvas.attr('height'), dowTimeseriesSmoothed, STRIPE_CHARTS[i].colorScale);
				}
			}

			// ===================================
			// Horizon chart
			// ==================================
			var horizonState = [0,0], horizonDirection = [1,1];
			function drawHorizonChart(timeseries)
			{
				var levels = 4;
				var svg1 = d3.select('#horizonChart1');
				var svg2 = d3.select('#horizonChart2');

				var w = +svg1.attr('width');
				var h = +svg1.attr('height') / levels;

				var group1 = svg1.append("g").attr('transform', 'translate(0,' + (levels-1)*h + ')');
				var horizon1 = new HorizonPlot(group1, w, h, timeseries, 4);

				var group2 = svg2.append("g").attr('transform', 'translate(0,' + (levels-1)*h + ')');
				var horizon2 = new HorizonPlot(group2, w, h, timeseries, 4, timeseries.calcMean());
				horizon2.drawTimeAxis(dow.getStartTime(), dow.getEndTime());

				svg1.on("dblclick", horizonDblClick);
				svg2.on("dblclick", horizonDblClick);

				function horizonDblClick() 
				{
					var hState, hDirection, horizon;
					if (d3.select(this).attr('id') == 'horizonChart1') 
					{
						hDirection = horizonDirection[0];
						hState = horizonState[0];
						horizon = horizon1;
					}
					else
					{
						hDirection = horizonDirection[1];
						hState = horizonState[1];						
						horizon = horizon2;
					}
					hState += hDirection;

					switch (hState) {
					
					case 0:
						horizon.colorBands('rgb(166,189,219)');
						break;
					case 1:
						horizon.colorBands();
						break;
					case 2:
						horizon.collapseBands();
						break;

					case 3:
						hDirection = 1;
						hState = -1;
						horizon.expandBands();
						break;
					}
					if (d3.select(this).attr('id') == 'horizonChart1') 
					{
						horizonDirection[0] = hDirection;
						horizonState[0] = hState;
					}
					else
					{
						horizonDirection[1] = hDirection;
						horizonState[1] = hState;
					}
				}
			}
			
		</script>
	</body>
</html>
